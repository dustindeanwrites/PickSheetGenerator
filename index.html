<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Pick Sheet Generator</title>
  <style>
      body {
          font-family: Arial, sans-serif;
          background-color: #f5f6f8;
          margin: 0;
          padding: 0;
      }

      .container {
          max-width: 800px;
          margin: 40px auto;
          background: #ffffff;
          padding: 30px;
          border-radius: 8px;
          box-shadow: 0 2px 10px rgba(0,0,0,0.08);
      }

      h1 {
          text-align: center;
          margin-bottom: 30px;
          color: #333;
      }

      .button-row {
          display: flex;
          justify-content: center;
          gap: 15px;
          margin-bottom: 25px;
      }

      button {
          padding: 10px 18px;
          border: none;
          border-radius: 5px;
          background-color: #007bff;
          color: #fff;
          font-size: 14px;
          cursor: pointer;
      }

      button:hover {
          background-color: #0056b3;
      }

      .order-form {
          display: none;
          margin-top: 20px;
          border-top: 1px solid #ddd;
          padding-top: 20px;
      }

      .form-group {
          margin-bottom: 15px;
      }

      label {
          display: block;
          font-weight: bold;
          margin-bottom: 5px;
          color: #444;
      }

      input[type="text"],
      textarea {
          width: 100%;
          padding: 8px;
          border: 1px solid #ccc;
          border-radius: 4px;
          font-size: 14px;
      }

      textarea {
          height: 180px;
          resize: vertical;
      }

      .submit-button {
          margin-top: 10px;
          background-color: #28a745;
      }

      .submit-button:hover {
          background-color: #1e7e34;
      }

      .order-list {
          margin-top: 20px;
          font-size: 14px;
          color: #333;
      }

      .order-list div {
          padding: 6px 0;
      }
  </style>
</head>
<body>

<div class="container">
  <h1>Pick Sheet Generator (vers 0.30)</h1>

  <div class="button-row">
    <button id="addOrderBtn">Add Order</button>
    <button id="exportBtn">Export Pick Sheets</button>
    <button id="resetBtn">Reset</button>
  </div>

  <div class="order-form" id="orderForm">
    <div class="form-group">
      <label>Order Number</label>
      <input type="text" id="orderNumber">
    </div>

    <div class="form-group">
      <label>Order Color</label>
      <input type="text" id="orderColor">
    </div>

    <div class="form-group">
      <label>Text Entry</label>
      <textarea id="textEntry"></textarea>
    </div>

    <button class="submit-button" id="submitOrderBtn">Submit Order</button>
  </div>

  <div class="order-list" id="orderList"></div>
</div>

<script>
  const addOrderBtn = document.getElementById('addOrderBtn');
  const submitOrderBtn = document.getElementById('submitOrderBtn');
  const resetBtn = document.getElementById('resetBtn');
  const exportBtn = document.getElementById('exportBtn');
  const orderForm = document.getElementById('orderForm');
  const orderList = document.getElementById('orderList');

  /* âœ… FIX: properly bind inputs */
  const orderNumberInput = document.getElementById('orderNumber');
  const orderColorInput = document.getElementById('orderColor');
  const textEntry = document.getElementById('textEntry');

  let orders = {};

  addOrderBtn.onclick = () => {
    orderForm.style.display = 'block';
  };

  resetBtn.onclick = () => {
    orderForm.style.display = 'none';
    orderList.innerHTML = '';
    orders = {};
  };

  function daysOld(dateString) {
    const [m, d, y] = dateString.split('/').map(Number);
    return (new Date() - new Date(y, m - 1, d)) / 86400000;
  }

  function formatLocation(raw) {
    if (raw === "60001000") return "NONE";
    if (/^\d{8}$/.test(raw)) {
      return `${raw.slice(0,2)}-${raw.slice(2,4)}-${raw.slice(4,6)}-${raw.slice(6)}`;
    }
    return raw;
  }

  /* ðŸ”§ BULLETPROOF NORMALIZATION */
  function normalizeInput(rawText) {
    const tokens = rawText.replace(/\s+/g, ' ').trim().split(' ');
    const rows = [];
    let buffer = [];

    for (let i = 0; i < tokens.length; i++) {
      buffer.push(tokens[i]);

      if (/^\d{2}\/\d{2}\/\d{4}$/.test(tokens[i])) {
        rows.push(buffer.join(' '));
        buffer = [];
      }
    }

    if (buffer.length) {
      let temp = [];
      buffer.forEach(tok => {
        temp.push(tok);
        if (/^\d{2}\/\d{2}\/\d{4}$/.test(tok)) {
          rows.push(temp.join(' '));
          temp = [];
        }
      });
    }

    return rows.join('\n');
  }

  function copyToClipboard(text) {
    try {
      if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(text);
      } else {
        fallbackCopy(text);
      }
    } catch {
      fallbackCopy(text);
    }
  }

  function fallbackCopy(text) {
    const ta = document.createElement("textarea");
    ta.value = text;
    ta.style.position = "fixed";
    ta.style.left = "-9999px";
    document.body.appendChild(ta);
    ta.select();
    document.execCommand("copy");
    document.body.removeChild(ta);
  }

  submitOrderBtn.onclick = () => {
    const orderNumber = orderNumberInput.value.trim();
    const orderColor = orderColorInput.value.trim();
    const text = textEntry.value.trim();

    if (!orderNumber || !orderColor || !text) {
      alert("Please complete all fields.");
      return;
    }

    const key = `${orderNumber}|${orderColor}`;

    if (!orders[key]) {
      orders[key] = { orderNumber, orderColor, rawText: text };
      const div = document.createElement('div');
      div.id = key;
      div.textContent = `${orderNumber} - ${orderColor} added.`;
      orderList.appendChild(div);
    } else {
      orders[key].rawText += "\n" + text;
      document.getElementById(key).textContent =
        `${orderNumber} - ${orderColor} updated.`;
    }

    orderForm.style.display = 'none';
    textEntry.value = '';
  };

  exportBtn.onclick = () => {
    let main = [], rejected = [], spare = [];
    let usedPallets = new Set();

    Object.values(orders).forEach(order => {
      let lastCode = '', lastQty = 0;
      const isEDI = order.orderNumber.startsWith('EDI');
      const maxAge = isEDI ? 7 : 30;

      const lines = normalizeInput(order.rawText).split('\n');
      const parsed = [];

      lines.forEach(line => {
        const p = line.split(/\s+/);
        let i = 0;

        if (/^\d{5}$/.test(p[i])) {
          lastCode = p[i++];
          lastQty = Number(p[i++]);
        }

        if (!p[i] || isNaN(p[i])) return;

        const boxes = Number(p[i++]);
        const palletId = p[i] + " " + p[i + 1];
        i += 2;

        if (usedPallets.has(palletId)) return;
        usedPallets.add(palletId);

        const loc = p[i++];
        const date = p[i];

        if (!/^\d{2}\/\d{2}\/\d{4}$/.test(date)) return;

        const age = daysOld(date);
        const is71 = /^\d{8}$/.test(loc) && loc.startsWith('71');

        const row = {
          orderNumber: order.orderNumber,
          orderColor: order.orderColor,
          productCode: lastCode,
          quantityNeeded: lastQty,
          palletId,
          boxes,
          location: formatLocation(loc),
          packedDate: date
        };

        if (!is71 && age > maxAge) {
          rejected.push({
            ...row,
            orderNumber: "REJECTED",
            orderColor: isEDI ? "OLD - EDI" : "OLD"
          });
        } else {
          parsed.push(row);
        }
      });

      const byCode = {};
      parsed.forEach(r => {
        if (!byCode[r.productCode]) byCode[r.productCode] = [];
        byCode[r.productCode].push(r);
      });

      Object.values(byCode).forEach(group => {
        group.sort((a,b)=>new Date(a.packedDate)-new Date(b.packedDate));
        let remaining = group[0].quantityNeeded;

        group.forEach(r => {
          if (remaining <= 0) {
            spare.push({ ...r, orderNumber:"SPARE", orderColor:"UNUSED", quantityNeeded:"" });
            return;
          }
          if (r.boxes <= remaining) {
            remaining -= r.boxes;
            main.push(r);
          } else {
            main.push({ ...r, boxes:`${r.boxes} need ${remaining}` });
            spare.push({ ...r, boxes:r.boxes-remaining, orderNumber:"SPARE", orderColor:"UNUSED", quantityNeeded:"" });
            remaining = 0;
          }
        });
      });
    });

    if (!main.length && !rejected.length && !spare.length) {
      alert("No valid rows detected â€” please check pasted input format.");
      return;
    }

    const header =
      "Order Number\tOrder Color\tProduct Code\tQuantity Needed\tPallet ID\tBoxes on Pallet\tLocation\tPacked Date";

    const rows = [header];
    main.forEach(r => rows.push(Object.values(r).join('\t')));
    if (rejected.length) rows.push('');
    rejected.forEach(r => rows.push(Object.values(r).join('\t')));
    if (spare.length) rows.push('');
    spare.forEach(r => rows.push(Object.values(r).join('\t')));

    copyToClipboard(rows.join('\n'));
    alert("Pick sheets copied to clipboard.");
  };
</script>

</body>
</html>
