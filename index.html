<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Pick Sheet Generator</title>
  <style>
      body {
          font-family: Arial, sans-serif;
          background-color: #f5f6f8;
          margin: 0;
          padding: 0;
      }

      .container {
          max-width: 800px;
          margin: 40px auto;
          background: #ffffff;
          padding: 30px;
          border-radius: 8px;
          box-shadow: 0 2px 10px rgba(0,0,0,0.08);
      }

      h1 {
          text-align: center;
          margin-bottom: 30px;
          color: #333;
      }

      .button-row {
          display: flex;
          justify-content: center;
          gap: 15px;
          margin-bottom: 25px;
      }

      button {
          padding: 10px 18px;
          border: none;
          border-radius: 5px;
          background-color: #007bff;
          color: #fff;
          font-size: 14px;
          cursor: pointer;
      }

      button:hover {
          background-color: #0056b3;
      }

      .order-form {
          display: none;
          margin-top: 20px;
          border-top: 1px solid #ddd;
          padding-top: 20px;
      }

      .form-group {
          margin-bottom: 15px;
      }

      label {
          display: block;
          font-weight: bold;
          margin-bottom: 5px;
          color: #444;
      }

      input[type="text"],
      textarea {
          width: 100%;
          padding: 8px;
          border: 1px solid #ccc;
          border-radius: 4px;
          font-size: 14px;
      }

      textarea {
          height: 180px;
          resize: vertical;
      }

      .submit-button {
          margin-top: 10px;
          background-color: #28a745;
      }

      .submit-button:hover {
          background-color: #1e7e34;
      }

      .order-list {
          margin-top: 20px;
          font-size: 14px;
          color: #333;
      }

      .order-list div {
          padding: 6px 0;
      }
  </style>
</head>
<body>

<div class="container">
  <h1>Pick Sheet Generator (vers 0.16)</h1>

  <div class="button-row">
    <button id="addOrderBtn">Add Order</button>
    <button id="exportBtn">Export Pick Sheets</button>
    <button id="resetBtn">Reset</button>
  </div>

  <div class="order-form" id="orderForm">
    <div class="form-group">
      <label>Order Number</label>
      <input type="text" id="orderNumber">
    </div>

    <div class="form-group">
      <label>Order Color</label>
      <input type="text" id="orderColor">
    </div>

    <div class="form-group">
      <label>Text Entry</label>
      <textarea id="textEntry"></textarea>
    </div>

    <button class="submit-button" id="submitOrderBtn">Submit Order</button>
  </div>

  <div class="order-list" id="orderList"></div>
</div>

<script>
  const addOrderBtn = document.getElementById('addOrderBtn');
  const submitOrderBtn = document.getElementById('submitOrderBtn');
  const resetBtn = document.getElementById('resetBtn');
  const exportBtn = document.getElementById('exportBtn');
  const orderForm = document.getElementById('orderForm');
  const orderList = document.getElementById('orderList');

  let mainItems = [];
  let extraItems = [];
  let rejectedItems = [];
  let usedPalletIds = new Set();

  addOrderBtn.onclick = () => {
    orderForm.style.display = 'block';
  };

  resetBtn.onclick = () => {
    document.getElementById('orderNumber').value = '';
    document.getElementById('orderColor').value = '';
    document.getElementById('textEntry').value = '';
    orderForm.style.display = 'none';
    orderList.innerHTML = '';
    mainItems = [];
    extraItems = [];
    rejectedItems = [];
    usedPalletIds.clear();
  };

  function daysOld(dateString) {
    const [mm, dd, yyyy] = dateString.split('/').map(Number);
    return (new Date() - new Date(yyyy, mm - 1, dd)) / 86400000;
  }

  function formatLocation(raw) {
    if (raw === "60001000") return "NONE";
    if (/^\d{8}$/.test(raw)) {
      return `${raw.slice(0,2)}-${raw.slice(2,4)}-${raw.slice(4,6)}-${raw.slice(6,8)}`;
    }
    return raw;
  }

  submitOrderBtn.onclick = () => {
    const orderNumber = document.getElementById('orderNumber').value.trim();
    const orderColor = document.getElementById('orderColor').value.trim();
    const text = document.getElementById('textEntry').value.trim();

    let lastProductCode = '';
    let lastQuantity = 0;

    const isEDI = orderNumber.startsWith('EDI');
    const maxAge = isEDI ? 7 : 30;

    const parsed = [];

    text.split(/\r?\n/).forEach(line => {
      const p = line.trim().split(/\s+/);
      let i = 0;

      if (/^\d{5}$/.test(p[i])) {
        lastProductCode = p[i++];
        lastQuantity = Number(p[i++]);
      }

      const boxes = Number(p[i++]);
      const palletId = p[i] + " " + p[i + 1];
      i += 2;

      // ðŸš« Skip pallet if already used
      if (usedPalletIds.has(palletId)) return;
      usedPalletIds.add(palletId);

      const rawLocation = p[i++];
      const packedDate = p[i];

      const age = daysOld(packedDate);
      const is71 = /^\d{8}$/.test(rawLocation) && rawLocation.startsWith('71');

      const item = {
        orderNumber,
        orderColor,
        productCode: lastProductCode,
        quantityNeeded: lastQuantity,
        boxes,
        palletId,
        rawLocation,
        location: formatLocation(rawLocation),
        packedDate
      };

      if (!is71 && age > maxAge) {
        rejectedItems.push({
          ...item,
          orderNumber: "REJECTED",
          orderColor: isEDI ? "OLD - EDI" : "OLD"
        });
      } else {
        parsed.push(item);
      }
    });

    // Group by Product Code
    const byProduct = {};
    parsed.forEach(i => {
      if (!byProduct[i.productCode]) byProduct[i.productCode] = [];
      byProduct[i.productCode].push(i);
    });

    Object.values(byProduct).forEach(group => {
      group.sort((a, b) => new Date(a.packedDate) - new Date(b.packedDate));

      let remaining = group[0].quantityNeeded;

      for (let row of group) {
        if (remaining <= 0) {
          extraItems.push(row);
          continue;
        }

        if (row.boxes < remaining) {
          remaining -= row.boxes;
          mainItems.push(row);
        } else if (row.boxes === remaining) {
          mainItems.push(row);
          remaining = 0;
        } else {
          row.boxes = `${row.boxes} need ${remaining}`;
          mainItems.push(row);
          remaining = 0;
        }
      }
    });

    const confirmation = document.createElement('div');
    confirmation.textContent = `${orderNumber} - ${orderColor} added.`;
    orderList.appendChild(confirmation);

    document.getElementById('orderNumber').value = '';
    document.getElementById('orderColor').value = '';
    document.getElementById('textEntry').value = '';
    orderForm.style.display = 'none';
  };

  exportBtn.onclick = () => {
    const header =
      "Order Number\tOrder Color\tProduct Code\tQuantity Needed\tPallet ID\tBoxes on Pallet\tLocation\tPacked Date";

    // Sort MAIN by location
    mainItems.sort((a, b) => {
      const aNum = /^\d/.test(a.location);
      const bNum = /^\d/.test(b.location);
      if (aNum && bNum) return a.location.localeCompare(b.location);
      if (aNum) return -1;
      if (bNum) return 1;
      return a.location.localeCompare(b.location);
    });

    const rows = [header];

    mainItems.forEach(i => rows.push([
      i.orderNumber, i.orderColor, i.productCode, i.quantityNeeded,
      i.palletId, i.boxes, i.location, i.packedDate
    ].join('\t')));

    extraItems.forEach(i => rows.push([
      "EXTRA", i.orderColor, i.productCode, i.quantityNeeded,
      i.palletId, i.boxes, i.location, i.packedDate
    ].join('\t')));

    rejectedItems.forEach(i => rows.push([
      i.orderNumber, i.orderColor, i.productCode, i.quantityNeeded,
      i.palletId, i.boxes, i.location, i.packedDate
    ].join('\t')));

    navigator.clipboard.writeText(rows.join('\n'));
    alert("Pick sheets copied to clipboard and ready for Excel.");
  };
</script>




</body>
</html>
